<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/common.css"/>

    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="css/define.css">

    <title>ccpool</title>
</head>
<body class="sidebar-mini fixed  pace-done">
<div class="pace  pace-inactive">
    <div class="pace-progress" data-progress-text="100%" data-progress="99"
         style="transform: translate3d(100%, 0px, 0px);">
        <div class="pace-progress-inner"></div>
    </div>
    <div class="pace-activity"></div>
</div>
<div class="wrapper">
    <!-- Navbar-->
    <header class="main-header hidden-print"><a class="logo" href="/html/index.html"
                                                style="margin-top:0px;font-size:40px;text-align:center;">ccpool</a>
        <nav class="navbar navbar-static-top">
            <a class="sidebar-toggle" href="/html/index.html" data-toggle="offcanvas"></a>
            <!-- Navbar Right Menu-->
            <div class="navbar-custom-menu">
                <ul class="top-nav">
                    <!--Notification Menu-->
                    <li class="dropdown notification-menu">
                        <a class="dropdown-toggle" href="/html/index.html" data-toggle="dropdown"
                           aria-expanded="false">
                            <i class="fa fa-bell-o fa-lg"></i>
                        </a>
                        <ul class="dropdown-menu">
                            <li class="not-head">你有4个消息待查看</li>
                            <li><a class="media" href="javascript:;"><span class="media-left media-icon"><span
                                    class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x text-primary"></i><i
                                    class="fa fa-envelope fa-stack-1x fa-inverse"></i></span></span>
                                <div class="media-body"><span class="block">有尚未审批的工单待处理</span><span
                                        class="text-muted block">2分钟前</span></div>
                            </a></li>
                            <li><a class="media" href="javascript:;"><span class="media-left media-icon"><span
                                    class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x text-danger"></i><i
                                    class="fa fa-hdd-o fa-stack-1x fa-inverse"></i></span></span>
                                <div class="media-body"><span class="block">你的密码是初始密码，请速修改</span><span
                                        class="text-muted block">1天前</span></div>
                            </a></li>
                            <li><a class="media" href="javascript:;"><span class="media-left media-icon"><span
                                    class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x text-success"></i><i
                                    class="fa fa-money fa-stack-1x fa-inverse"></i></span></span>
                                <div class="media-body"><span class="block">有合约即将到期，请联系客户续约</span><span
                                        class="text-muted block">5天前</span></div>
                            </a></li>
                            <li class="not-footer"><a href="#">查看所有提醒</a></li>
                        </ul>
                    </li>
                    <!-- User Menu-->
                    <li class="dropdown">
                        <a class="dropdown-toggle" href="/html/index.html" data-toggle="dropdown" role="button"
                           aria-haspopup="true" aria-expanded="false">
                            <i class="fa fa-user fa-lg"></i>
                        </a>
                        <ul class="dropdown-menu settings-menu">
                            <li><a href="#"><i
                                    class="fa fa-cog fa-lg"></i> 设置</a></li>
                            <li><a href="#"><i
                                    class="fa fa-user fa-lg"></i>配置</a></li>
                            <li><a href="/html/index.html"><i
                                    class="fa fa-sign-out fa-lg"></i>退出</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </header>
    <!-- Side-Nav-->
    <aside class="main-sidebar hidden-print">
        <div class="slimScrollDiv" style="position: relative; overflow: hidden; width: auto; height: 1284px;">
            <section class="sidebar" style="overflow: hidden; width: auto; height: 1284px;">
                <div class="user-panel">
                    <div class="pull-left image"><img class="img-circle" src="images/48.jpg" alt="User Image"></div>
                    <div class="pull-left info">
                        <p id="userName"></p>
                        <p class="designation">超级管理员</p>
                    </div>
                </div>
                <!-- Sidebar Menu-->
                <ul class="sidebar-menu">
                    <li class="active">
                        <a href="#" onclick="jump(1)"><i class="fa fa-dashboard"></i><span>用户管理</span></a>
                    </li>
                    <li class="active">
                        <a href="#" onclick="jump(5)"><i class="fa fa-dashboard"></i><span>合约管理</span></a>
                    </li>
                    <li class="active">
                        <a href="#" onclick="jump(10)"><i class="fa fa-dashboard"></i><span>工单管理</span></a>
                    </li>
                    <li class="active">
                        <a href="#" onclick="jump(6)"><i class="fa fa-dashboard"></i><span>参数设置</span></a>
                    </li>
                    <li class="active">
                        <a href="#" onclick="jump(7)"><i class="fa fa-dashboard"></i><span>公告管理</span></a>
                    </li>
                    <li class="active">
                        <a href="#" onclick="jump(8)"><i class="fa fa-dashboard"></i><span>常见问题管理</span></a>
                    </li>
                    <li class="active">
                        <a href="#" onclick="jump(9)"><i class="fa fa-dashboard"></i><span>留言管理</span></a>
                    </li>
                </ul>
            </section>
            <div class="slimScrollBar"
                 style="background: rgba(0, 0, 0, 0.8); width: 3px; position: absolute; top: 0px; opacity: 0.4; display: none; border-radius: 7px; z-index: 99; right: 1px; height: 1284px;"></div>
            <div class="slimScrollRail"
                 style="width: 3px; height: 100%; position: absolute; top: 0px; display: none; border-radius: 7px; background: rgb(51, 51, 51); opacity: 0.2; z-index: 90; right: 1px;"></div>
        </div>
    </aside>

    <div class="content-wrapper" id="worklist_page">
        <div class="page-title" style="margin:-25px -20px;">
            <div>
                <h1><i class="fa fa-dashboard"></i><span><a href="#">工单管理</a></span></h1>
            </div>
            <div>
                <ul class="breadcrumb">
                    <li><i class="fa fa-home fa-lg"></i></li>
                    <li><a href="/html/index.html">概况</a></li>
                </ul>
            </div>
        </div>
        <div class="row" style="margin:30px -35px;" id="worklist_manager">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div id="worklist_manager_wrapper"
                             class="dataTables_wrapper form-inline dt-bootstrap no-footer">
                            <div class="row">
                                <div class="col-sm-12">
                                    <table class="table table-hover table-bordered dataTable no-footer"
                                           id="worklist_manager_table"
                                           role="grid" aria-describedby="sampleTable_info">
                                        <thead>
                                        <tr role="row">
                                            <th class="sorting_asc" tabindex="0" aria-controls="sampleTable" rowspan="1"
                                                colspan="1" aria-sort="ascending"
                                                aria-label="id: activate to sort column descending">ID
                                            </th>
                                            <th class="sorting" tabindex="0" aria-controls="sampleTable" rowspan="1"
                                                colspan="1" aria-label="Office: activate to sort column ascending">用户名
                                            </th>
                                            <th class="sorting" tabindex="0" aria-controls="sampleTable" rowspan="1"
                                                colspan="1" aria-label="Office: activate to sort column ascending">合约名称
                                            </th>
                                            <th class="sorting" tabindex="0" aria-controls="sampleTable" rowspan="1"
                                                colspan="1" aria-label="Office: activate to sort column ascending">类型
                                            </th>
                                            <th class="sorting" tabindex="0" aria-controls="sampleTable" rowspan="1"
                                                colspan="1" aria-label="Start date: activate to sort column ascending">
                                                提交时间
                                            </th>
                                            <th class="sorting" tabindex="0" aria-controls="sampleTable" rowspan="1"
                                                colspan="1" aria-label="Start date: activate to sort column ascending">
                                                通过时间
                                            </th>
                                            <th class="sorting" tabindex="0" aria-controls="sampleTable" rowspan="1"
                                                colspan="1" aria-label="Start date: activate to sort column ascending">
                                                状态
                                            </th>
                                            <th class="sorting" tabindex="0" aria-controls="sampleTable" rowspan="1"
                                                colspan="1" aria-label="Salary: activate to sort column ascending">
                                                未审批通过原因
                                            </th>
                                            <th class="sorting" tabindex="0" aria-controls="sampleTable" rowspan="1"
                                                colspan="1" aria-label="Salary: activate to sort column ascending">操作
                                            </th>
                                        </tr>
                                        </thead>
                                        <tbody id="worklist_manager_table_tbody">

                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>

<!-- Javascripts-->
<script src="js/jquery-2.1.4.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/pace.min.js"></script>
<script src="js/main.js"></script>
<script src="js/prototype.js"></script>
<script src="js/webcommon.js"></script>
<script type="text/javascript" src="js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="js/dataTables.bootstrap.min.js"></script>

<div id="dialogBg"></div>
<div id="dialog" class="animated">
    <img class="dialogIco" width="50" height="50" src="images/ico.png" alt=""/>
    <div class="dialogTop">
        <a href="javascript:;" class="claseDialogBtn">关闭</a>
    </div>
    <form action="" method="post" id="worklist_state_update_form">
        <div class="dataTables_wrapper form-inline dt-bootstrap no-footer">
            <div class="row">
                <div class="col-sm-12">
                    <table id="config_table" class="table table-hover table-bordered dataTable no-footer" role="grid"
                           aria-describedby="sampleTable_info" style="width:800px;margin-left:100px;">
                        <thead>
                        <tr role="row" id="config_title">
                        </tr>
                        </thead>
                        <tbody id="config_body">
                        </tbody>
                    </table>
                </div>

                <div class="col-sm-12">
                    <div class="row" style="margin-top:10px;">
                        <span style="float:left;padding-top:5px;margin-left:115px;color:#000000;">工单状态：</span>
                        <select class="ipt" style="float:left;" id="w_worklist_state" onchange="WorklistStateChange(this.value)">
                            <option value="待审批">待审批</option>
                            <option value="审批通过">审批通过</option>
                            <option value="未审批通过">未审批通过</option>
                        </select>
                    </div>
                    <div hidden id="div_reason" class="row" style="margin-top:10px;">
                        <span style="color:#000000;float:left;margin-left:115px;">未通过原因：</span></br>
                        <textarea rows="5" cols="111" id="w_reason" style="margin-left:115px;border:1px solid #ccc;border-radius: 0.3em;float: left;"> </textarea>

                    </div>
                    <input type="hidden" id="hidWorklistID" />
                    <input type="button" style="position:relative;float: left;left:50%;margin-left:-30px;margin-top:20px;" value="确认提交" class="submitBtn" id="btnUpdateWorklistState"/>
                </div>

            </div>
        </div>
    </form>
</div>

<script type="text/javascript">

    function getParam(paramName) {
        paramValue = "", isFound = !1;
        if (this.location.search.indexOf("?") == 0 && this.location.search.indexOf("=") > 1) {
            arrSource = unescape(this.location.search).substring(1, this.location.search.length).split("&"), i = 0;
            while (i < arrSource.length && !isFound) arrSource[i].indexOf("=") > 0 && arrSource[i].split("=")[0].toLowerCase() == paramName.toLowerCase() && (paramValue = arrSource[i].split("=")[1], isFound = !0), i++
        }
        return paramValue == "" && (paramValue = null), paramValue
    }

    var w, h;
    function getSrceenWH() {
        w = $(window).width();
        h = $(window).height();
        $('#dialogBg').width(w).height(h);
    }

    window.onresize = function () {
        getSrceenWH();
    }
    $(window).resize();

    getSrceenWH();

    function closeDialog() {
        $('#dialogBg').fadeOut(100, function () {
            $('#dialog').addClass('bounceOutUp').fadeOut();
        });
    }

    $("#dialog").css("position", "absolute");
    $("#dialog").css("left", "50%");
    $("#dialog").css("top", "50%");
    $("#dialog").css("width", "1000px");
    $("#dialog").css("height", "600px");
    $(".ipt").css("width", "250px");

    $("#dialog").css("margin", "-300px 0 0 -450px");

    function WorklistStateChange(obj) {
        if (obj == "未审批通过") {
            $("#div_reason").show();
        } else {
            $("#div_reason").hide();
        }
    }

    //关闭弹窗
    $('.claseDialogBtn').click(function () {
        closeDialog();
    });

    $("#btnUpdateWorklistState").click(function () {
        var token = getParam("Authorization");

        var s = $("#w_worklist_state").val();
        var id = $("#hidWorklistID").val();
        var reason = $("#w_reason").val();

        var state = 1;
        if (s == "待审批") {
            state = 1;
        } else if (s == "审批通过") {
            state = 2;
        } else if (s == "未审批通过") {
            state = 3;
        }

        if (state == 3 && reason.length == 0) {
            alert("未审批通过时，原因不能未空");
            return
        }

        var url = "/ams/user/worklist/approve?Authorization=" + token + "&id=" + id + "&state=" + state + "&reason=" + reason;
        $.getJSON(url, function (json) {
            if (json.err_code == 0) {
                alert("修改成功");
            } else if(json.err_code == 1) {
                alert(json.err_msg);
            }else{
                alert("修改失败");
            }
            closeDialog();
            window.location.reload()
        });
    });

    function WorklistPageInit() {
        var userName = $.cookie("admin_name");
        $("#userName").text(userName);

        var token = getParam("Authorization");

        $.getJSON("/ams/user/worklist/list?Authorization=" + token, function (json) {
            if (json.err_code == 0) {
                var tbody = "";

                for (var i = 0; i < json.data.length; i++) {

                    var state = "";

                    if (json.data[i].state == 1) {
                        state = "待审批";
                    } else if (json.data[i].state == 2) {
                        state = "审批通过";
                    } else if (json.data[i].state == 3) {
                        state = "未审批通过";
                    }else if (json.data[i].state == 4) {
                        state = "激活中";
                    }else if (json.data[i].state == 5) {
                        state = "已激活";
                    }

                    var pattern = "";
                    if (json.data[i].pattern == 1) {
                        pattern = "算力模式"
                    } else {
                        pattern = "机器模式"
                    }

                    tbody += "<tr role='row' class='odd'>";
                    tbody += "<td>" + json.data[i].id + "</td>";
                    tbody += "<td>" + json.data[i].user_name + "</td>";
                    tbody += "<td>" + json.data[i].con_name + "</td>";
                    tbody += "<td>" + pattern + "</td>";
                    tbody += "<td>" + json.data[i].submit_date + "</td>";
                    tbody += "<td>" + json.data[i].pass_date + "</td>";
                    tbody += "<td>" + state + "</td>";
                    tbody += "<td>" + json.data[i].reason + "</td>";
                    tbody += "<td><a href='#' onclick='DialogApprove(" + json.data[i].id + "," + json.data[i].state +")'>审批</a><a style='margin-left:20px;' href='#' onclick='ActiveWorkList(" + json.data[i].id + ")'>激活</a></td>";
                    tbody += "</tr>";
                }

                $("#worklist_manager_table_tbody").html(tbody);

                var table = $('#worklist_manager_table').dataTable({
                    "bStateSave": false,//状态保存
                    "bPaginate": true, //翻页功能
                    "bLengthChange": true, //改变每页显示数据数量
                    "bFilter": true, //过滤功能
                    "bSort": true, //排序功能
                    "bInfo": true,//页脚信息
                    "paging": true,
                    "retrieve": true,
                    "bAutoWidth": true,//自动宽度
                    "iDisplayLength": 25,// 每页显示行数
                    "aaSorting": [[1, "asc"]], //默认的排序方式，第2列，升序排列
                    "oLanguage": {
                        "sLengthMenu": "每页显示 _MENU_ 条记录",
                        "sZeroRecords": "对不起，查询不到任何相关数据",
                        "sInfo": "当前显示 _START_ 到 _END_ 条，共 _TOTAL_ 条记录",
                        "sInfoEmtpy": "找不到相关数据",
                        "sInfoFiltered": "数据表中共为 _MAX_ 条记录)",
                        "sProcessing": "正在加载中...",
                        "sSearch": "搜索",
                        "sUrl": "", //多语言配置文件，可将oLanguage的设置放在一个txt文件中，例：Javascript/datatable/dtCH.txt
                        "oPaginate": {
                            "sFirst": "第一页",
                            "sPrevious": " 上一页 ",
                            "sNext": " 下一页 ",
                            "sLast": " 最后一页 "
                        }
                    }
                });

                table.search("").draw();


            } else {
                toastr.warning("获取用户列表失败!!!");
            }
        });
    }

    function ActiveWorkList(worklistid) {
        var token = getParam("Authorization");

        $.getJSON("/ams/user/worklist/active?Authorization=" + token + "&work_id=" + worklistid, function (json) {
            if (json.err_code == 0) {
                alert("提交成功，正在激活中，请稍后查询激活状态");
                window.location.reload();
            } else if (json.err_code == 1) {
                alert(json.err_msg);
            } else {
                toastr.warning("分配机器失败，请稍后再试!!!");
            }
        });
    }

    WorklistPageInit();

    function DialogApprove(work_id,state) {
        if(state != 1 && state != 3){
            alert("已审批通过，无需再次审批");
            return;
        }
        var token = getParam("Authorization");

        $("#worklist_state_update_form").show();
        $("#hidWorklistID").val(work_id);

        $.getJSON("/ams/user/worklist/info?Authorization=" + token+"&work_id="+work_id, function (json) {
            if (json.err_code == 0) {

//                var machine = new Array("机型","合约数量","可用数量","申请激活数量");
//                var pow = new Array("合约算力","未激活算力","申请激活算力");

                var config_title = "";

                if(json.data.pattern == 2){
                    config_title += '<th class="sorting_asc" tabindex="0" aria-controls="sampleTable" rowspan="1" colspan="1" aria-sort="ascending" aria-label="id: activate to sort column descending">机型</th>';
                    config_title += '<th class="sorting_asc" tabindex="0" aria-controls="sampleTable" rowspan="1" colspan="1" aria-sort="ascending" aria-label="id: activate to sort column descending">合约数量</th>';
                    config_title += '<th class="sorting_asc" tabindex="0" aria-controls="sampleTable" rowspan="1" colspan="1" aria-sort="ascending" aria-label="id: activate to sort column descending">可用数量</th>';
                    config_title += '<th class="sorting_asc" tabindex="0" aria-controls="sampleTable" rowspan="1" colspan="1" aria-sort="ascending" aria-label="id: activate to sort column descending">申请激活数量</th>';
                }else{
                    config_title += '<th class="sorting_asc" tabindex="0" aria-controls="sampleTable" rowspan="1" colspan="1" aria-sort="ascending" aria-label="id: activate to sort column descending">合约算力</th>';
                    config_title += '<th class="sorting_asc" tabindex="0" aria-controls="sampleTable" rowspan="1" colspan="1" aria-sort="ascending" aria-label="id: activate to sort column descending">未激活算力</th>';
                    config_title += '<th class="sorting_asc" tabindex="0" aria-controls="sampleTable" rowspan="1" colspan="1" aria-sort="ascending" aria-label="id: activate to sort column descending">申请激活算力</th>';
                }

                $("#config_title").html(config_title);

                var tbody = "";
                for (var i = 0; i < json.data.item.length; i++) {

                    tbody += '<tr role="row" class="odd">';
                    if(json.data.pattern == 2){
                        tbody += '<td class="">' + json.data.item[i].type + '</td>';
                        tbody += '<td class="">' + json.data.item[i].total + '</td>';
                        tbody += '<td class="">' + json.data.item[i].remain + '</td>';
                        tbody += '<td class="">' + json.data.item[i].active + '</td>';
                    }else{
                        tbody += '<td class="">' + json.data.item[i].total + '</td>';
                        tbody += '<td class="">' + json.data.item[i].remain + '</td>';
                        tbody += '<td class="">' + json.data.item[i].active + '</td>';
                    }

                    tbody += '</tr>';
                }

                $("#config_body").html(tbody);

                if(json.data.state == 1){
                    $("#w_worklist_state").val("待审批")
                }else if(json.data.state == 2){
                    $("#w_worklist_state").val("审批通过")
                }else if(json.data.state == 3){
                    $("#div_reason").show();
                    $("#w_reason").val(json.data.reason);
                    $("#w_worklist_state").val("未审批通过")
                }

            } else {
                toastr.warning("获取用户列表失败!!!");
            }
        });

        $('#dialogBg').fadeIn(300);
        $('#dialog').removeAttr('class').addClass('animated bounceIn').fadeIn();

    }

    function jump(obj, id) {
        var token = getParam("Authorization");

        if (obj == 1) {
            location.href = "http://" + window.location.host + "/html/user1.html?" + "Authorization=" + token;
        } else if (obj == 2) {
            location.href = "http://" + window.location.host + "/html/userwallet.html?" + "Authorization=" + token + "&user_id=" + id;
        } else if (obj == 3) {
            location.href = "http://" + window.location.host + "/html/sonuser.html?" + "Authorization=" + token + "&parent_id=" + id;
        } else if (obj == 4) {
            location.href = "http://" + window.location.host + "/html/usermachine.html?" + "Authorization=" + token + "&user_id=" + id;
        } else if (obj == 5) {
            location.href = "http://" + window.location.host + "/html/contract.html?" + "Authorization=" + token;
        } else if (obj == 6) {
            location.href = "http://" + window.location.host + "/html/paramset.html?" + "Authorization=" + token;
        } else if (obj == 7) {
            location.href = "http://" + window.location.host + "/html/notice.html?" + "Authorization=" + token;
        } else if (obj == 8) {
            location.href = "http://" + window.location.host + "/html/question.html?" + "Authorization=" + token;
        } else if (obj == 9) {
            location.href = "http://" + window.location.host + "/html/msgboard.html?" + "Authorization=" + token;
        } else if (obj == 10) {
            location.href = "http://" + window.location.host + "/html/worklist.html?" + "Authorization=" + token;
        }
    }

</script>

</body>
</html>